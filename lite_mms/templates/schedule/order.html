{% extends "layout.html" %}
{% block __data_browser__custom_external_block %}
  {{ super() }}
  <script type="text/javascript">
    $(function () {
      $("input[name='check_all']").click(function () {
        $("input[name='work_command_id']").attr("checked", this.checked)
      });
      $("#schedule-button").click(function () {
        var id = $("input[name='work_command_id']:checked").val();
        if (jQuery.type(id) == "undefined") {
          alert("请选择记录");
          return false;
        } else {
          $(this).attr("disable", true);
          $("#work_command_form").submit();
        }
      });
    });
  </script>
{% endblock %}
{% block body %}
  <div class="container">
    <div id="order_info" class="form-horizontal">
      <legend>订单详情</legend>
      <div class="control-group">
        <label class="control-label"><strong>订单编号</strong></label>

        <div class="controls">
          <p class="padding">
            {{ order.customer_order_number }}
          </p>
        </div>
      </div>
      <div class="control-group">
        <label class="control-label"><strong>客户名称</strong></label>

        <div class="controls">
          <p class="padding">
            {{ order.customer.name }}
          </p>
        </div>
      </div>
      <div class="control-group">
        <label class="control-label"><strong>创建时间</strong></label>

        <div class="controls">
          <p class="padding">
            {{ order.create_time }}
          </p>
        </div>
      </div>
      <div class="control-group">
        <label class="control-label"><strong>总重量(KG)</strong></label>

        <div class="controls">
          <p class="padding">
            {{ order.net_weight }}
          </p>
        </div>
      </div>
      <div class="control-group">
        <label class="control-label"><strong>未预排产重量(KG)</strong></label>

        <div class="controls">
          <p class="padding">
            {{ order.remaining_weight }}
          </p>
        </div>
      </div>
      <div class="control-group">
        <label class="control-label"><strong>待排产工单数</strong></label>

        <div class="controls">
          <p class="padding">
            {{ order.todo_work_cnt }}
          </p>
        </div>
      </div>
      <div class="control-group">
        <label class="control-label"><strong>是否加急</strong></label>

        <div class="controls">
          {% if order.urgent %}
            <p class="padding text-error">是</p>
          {% else %}
            <p class="padding">否</p>
          {% endif %}
        </div>
      </div>

      <legend>子订单列表</legend>
      <table id="sub_order_table" class="table table-striped table-bordered table-condensed">
        <thead>
        <tr>
          <th>子订单号</th>
          <th>产品名称</th>
          <th>是否加急</th>
          <th>交货时间</th>
          <th>总重量(KG)</th>
          {% if not order.measured_by_weight %}
            <th>数量</th>
            <th>数量单位</th>
            <th>规格-型号</th>
          {% endif %}
          <th>是否退货</th>
          <th>待排产工单数</th>
          <th>待预排产数量</th>
          <th>技术要求</th>
          <th>卸货点</th>
          <th></th>
        </tr>
        </thead>
        <tbody>
        {% for sub_order in order.sub_order_list if sub_order.due_time %}
          <tr>
            <td>{{ sub_order.id }}</td>
            <td>{{ sub_order.product.name }}</td>

            {% if sub_order.urgent %}
              <td class="text-error">是</td>
            {% else %}
              <td>否</td>
            {% endif %}
            <td>{% if sub_order.due_time %}
              {{ sub_order.due_time.date() }}{% else %}
              ----{% endif %}</td>
            <td>{{ sub_order.weight }}</td>
            {% if not order.measured_by_weight %}
              <td>{{ sub_order.quantity }}</td>
              <td>{{ sub_order.unit }}</td>
              <td>{{ (sub_order.spec, sub_order.type)|join("-") }}</td>
            {% endif %}
            {% if sub_order.returned %}
              <td class="text-error">是</td>
            {% else %}
              <td>否</td>
            {% endif %}
            <td {% if not sub_order.pre_work_command %}
              class="text-error"
            {% endif %} >
              {{ sub_order.pre_work_command_list|length }}
            </td>
            <td
                {% if not sub_order.remaining_quantity %} class="text-error" {% endif %} >
              {{ sub_order.remaining_quantity }}({{ sub_order.unit }})
            </td>
            <td>{{ sub_order.tech_req }}</td>
            <td>{{ sub_order.harbor.name }}</td>
            <td>
              {% if sub_order.remaining_quantity|int > 0 and order.refined and order.dispatched %}
                <a class="btn btn-primary" name="{{ sub_order.id }}" href="{{ url_for('schedule.work_command',sub_order_id=sub_order.id,url=request.url) }}">
                  <i class="icon-wrench icon-white"></i>&nbsp;{{ "质检检货" if sub_order.returned else "预排产" }}
                </a>
              {% elif not order.refined or not order.dispatched %}
                <em>未下发</em>
              {% else %}
                ---
              {% endif %}
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
      <legend>待排产工单列表</legend>

      <form method="GET" id="work_command_form" action="{{ url_for('manufacture.schedule') }}">
        <table class="table table-striped table-bordered table-condensed">
          <thead>
          <tr>
            <th>
              <input type="checkbox" name="check_all">
            </th>
            <th>产品名称</th>
            <th>预排产重量（KG）</th>
            {% if not order.measured_by_weight %}
              <th>预排产的数量</th>
            {% endif %}
            <th>工序</th>
            <th>上道工序</th>
            <th>交货日期</th>
          </tr>
          </thead>
          <tbody>
          {% for sub_order in order.sub_order_list if sub_order.due_time %}
            {% for wc in sub_order.pre_work_command_list %}
              <tr>
                <td>
                  <input type="checkbox" name="work_command_id" value="{{ wc.id }}">
                </td>
                <td>{{ sub_order.product.name }}</td>
                <td>{{ wc.org_weight }}</td>
                {% if not order.measured_by_weight %}
                  <td>{{ wc.org_cnt }}</td>
                {% endif %}
                <td>{{ wc.procedure.name }}</td>
                <td>{% if wc.previous_procedure %}
                  {{ wc.previous_procedure.name }}{% endif %}</td>
                <td>{{ sub_order.due_time.date() }}</td>
              </tr>
            {% endfor %}
          {% endfor %}
          </tbody>
        </table>
        <button class="btn btn-primary btn-large" id="schedule-button" type="button">
          排产
        </button>
        <input type="hidden" name="url" value="{{ request.url }}">
      </form>
      <div class="control-group">
        <div class="controls">
          <a class="btn btn-info btn-large" name="{{ order.id }}" href="{{ url_for('manufacture.work_command_list', order_id=order.id, url=request.url) }}">
            <i class="icon-eye-open icon-white"></i>&nbsp;查看工单
          </a>
          <a class="btn btn-large" href="{{ request.args.get("url") or url_for('schedule.order_list') }}">
            <i class="icon-backward"></i>&nbsp;返回
          </a>
        </div>
      </div>

    </div>
  </div>
{% endblock %}
