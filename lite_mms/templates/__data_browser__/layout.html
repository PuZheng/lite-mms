{% extends "__data_browser__/base_layout.html" %}

{% block __data_browser__title_block %}
  {{ titlename }} - 金禾域生产管理系统 
{% endblock %}

{% block __data_browser__customized_head_block %}
<link rel="stylesheet" href="{{ url_for('static', filename="css/customer.css") }}" />
{% if g.request_from_mobile %}
<script type="text/javascript" src="{{ url_for("static", filename="js/cordova-2.5.0.js") }}"></script>
{% endif %}
  <script type="text/javascript" src="{{ url_for("static", filename="js/JSPinYin.js") }}"></script>
<script type="text/javascript">
  {% if g.request_from_mobile %}
  function onLoad() {
      document.addEventListener("deviceready", onDeviceReady, false);
  }
  window.onload = onLoad();

  function onDeviceReady() {
      document.addEventListener("menubutton", onMenuKeyDown, false);
  }

  function onMenuKeyDown() {
    $(".context-menu").toggle();
  }

  $(function () {
    $(".context-menu").hide();
    $(".context-menu .refresh-btn").click(function (e) {
     location.reload();
     return false;
     });
    });
  {% endif %}
  $(function () {

    setTimeout(function () {
      $(".flash").fadeOut("slow")
    }, 3000);
    function my_matcher(term, text) {
      return pinyin.getCamelChars(text).toUpperCase().indexOf(term.toUpperCase()) >= 0;
    }

    if ($("select").data("select2") == undefined || $("select").data("select2") == null) {
      $("select").select2({
        width: "element",
        placeholder: "请选择",
        matcher: my_matcher
      });
    } else {
      $("select").each(function () {
        $(this).data("select2").opts.placeholder = "请选择";
        $(this).data("select2").opts.matcher = my_matcher;
      });
    }
    $("[data-toggle=tooltip]").tooltip();
    // 展示代办事项
    $.pnotify.defaults.history = false;
    var stack_bottomright = {"dir1": "up", "dir2": "left", "firstpos1": 25, "firstpos2": 25};

    function display(message) {
      var ret = message["msg"];
      if (message.context_url.length > 0) {
        ret += sprintf('<a href="%s">开始&gt;&gt;</a>', message.context_url)
      }
      return ret;
    }
    function f() {
      $.getJSON('{{ url_for("ajax_new_message") }}', function (data) {
          var messages = data["messages"];
          for (var i = 0; i < messages.length; i++) {
          $.pnotify({
            title: '新待办事项',
            text: display(messages[i]), 
            addclass: "stack-bottomright",
            stack: stack_bottomright
            });
          }
        var e = $('header a[href="/todo/todo-list"]');
        e.html(e.html().replace(/待办事项(\(\d+\))?/, "待办事项("+data["total_cnt"]+")"));
        setTimeout(f, 30000);
      })
    };
    f();
  })
</script>
<style type="text/css">
  .stack-bottomright {
    /* These are just CSS default values to reset the pnotify CSS. */
    right: auto;
    top: auto;
  }
</style>
{% endblock %}

{% block __data_browser__nav_bar_block %}
<header class="navbar navbar-inverse navbar-fixed-top">
<div class="navbar-inner">
  <div class="container">
    {% if g.request_from_mobile %}
      <div class="brand">
        LITE-MMS <small><i>- {{ titlename }}</i></small>
      </div>
      {% if current_user.is_authenticated() and nav_bar %}
      <a href="#" class="btn btn-navbar">
        <i class="icon-search nav-text"></i> 
      </a>
      <button class="btn btn-navbar" data-target=".nav-collapse" data-toggle="collapse" type="button">
        <i class="icon-reorder"></i> 
      </button>
      <nav class="nav-collapse">
        {{ nav_bar.as_ul("active")|safe }}
        <ul class="nav">
          <li>
            <a href="{{ url_for('auth.logout') }}" class="navbar-text">
              <i class="icon-off icon-large"></i>
            </a>
          </li>
        </ul>
      </nav>
      {% endif %}
    {% else %}
      <div class="brand">
        LITE-MMS
      </div>
      {% if current_user.is_authenticated() and nav_bar is defined %}
      <button class="btn btn-navbar" data-target=".nav-collapse" data-toggle="collapse" type="button">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <nav class="nav-collapse">
      {{ nav_bar.as_ul("active", grouped=True)|safe }}
      <form class="navbar-search pull-right form-search"
        action="{{ url_for('search.search') }}" method="GET">
        <div class="input-append">
          <input class="search-query span2" type="text"
          placeholder="关键词..." name="content"
          {% if keywords %}value="{{ keywords }}"{% endif %}/>
          <button class="btn btn-inverse">搜索</button>
        </div>
      </form>
      <bold class="navbar-text pull-right">
      欢迎
      <mark><strong>{{ current_user.username }}</strong>
      </mark>
      您是
      <strong>{{ current_user.group_name }}</strong>
      <a href="{{ url_for('auth.logout') }}">退出</a>
      </bold>
      </nav>
      {% endif %}
    {% endif %}
  </div>
</div>
</header>
{% endblock %}

{% block __data_browser__footer_block %}
<footer class="footer hidden-phone">
  <div class="container">
    <div class="muted">
      copyright@ LITE-MMS
    </div>
  </div>
</footer>
{% if g.request_from_mobile %}
<div class="context-menu collapse in navbar-fixed-bottom">
  <div class="btn-group">
    <a href="#" class="btn btn-large refresh-btn">
      <i class="icon-refresh"></i>
      <span>刷新</span>
    </a>
  </div>
</div>
{% endif %}
{% endblock %}
