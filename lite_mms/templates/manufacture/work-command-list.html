{% extends "layout.html" %}
{% block custom_external %}
    <script src="{{ url_for('static',filename="js/delParam.js") }}" type="text/javascript"></script>
    <script src="{{ url_for('static',filename="js/getParameter.js") }}" type="text/javascript"></script>
    <script type="text/javascript">
        $(function () {
            function makeRed(select, value) {
                select.each(function (i) {
                    if ($.trim($(this).text()) == value) {
                        $(this).css("color", "red")
                    }
                });
            }

            makeRed($(".td-urgent"), "是");
            $('#status').val('{{ status }}');
            $('#harbor').val('{{ harbor }}');
            function changeVal() {
                var status = $('#status').children('option:selected').val();
                if (status == undefined) {
                    status = 1
                }
                var harbor = $('#harbor').children('option:selected').val();
                if (getParameter("order_id") != ""){
                    location.href = "{{ url_for('manufacture.work_command_list') }}?status=" +
                            status + "&harbor=" + harbor + "&order_id=" + getParameter("order_id");
                }else{
                    location.href = "{{ url_for('manufacture.work_command_list') }}?status=" +
                            status + "&harbor=" + harbor
                }

            }

            $('#status').change(function () {
                changeVal();
            });
            $('#harbor').change(function () {
                changeVal();
            });

            $("#schedule-button").click(function () {
                var id = $("input[name='work_command_id']:checked").val();
                if (jQuery.type(id) == "undefined") {
                    alert("请选择记录");
                    return false;
                } else {
                    $(this).attr("disable", true);
                    var history = delParam(location.href, 'result');
                    $("input[name=purl]").val(history);
                    $("#work_command_form").attr("method", "GET");
                    $("#work_command_form").attr("action", "{{ url_for('manufacture.schedule') }}")
                    $("#work_command_form").submit()
                }
            });
            $("#retrieve-button").click(function () {
                var id = $("input[name='work_command_id']:checked").val();
                if (jQuery.type(id) == "undefined") {
                    alert("请选择记录");
                    return;
                } else {
                    $(this).attr("disable", true);
                    var history = encodeURIComponent(delParam(location.href, 'result'));
                    $("input[name=purl]").val(history);
                    $("#work_command_form").attr("action", "{{ url_for('manufacture.retrieve') }}")
                    $("#work_command_form").submit()
                }
            });
            {% with messages = get_flashed_messages() %}
                {% if messages %}
                    $("#ym-message-dialog").show();
                    setTimeout(function () {
                        $("#ym-message-dialog").fadeOut("slow")
                    }, 2000);
                    $("#ym-message-dialog p").removeClass();
                    $("#ym-message-dialog p").addClass("box success");
                    $("#ym-message-dialog p").text("{{ messages[0] }}");
                {% else %}
                    $("#ym-message-dialog").hide();
                {% endif %}
            {% endwith %}
            $("input[name='check_all']").click(function () {
                $("input[name='work_command_id']").attr("checked", this.checked)
            });
            unnormalArray = new Array();
            {% for work_command in work_command_list %}
                {% if not work_command.retrievable %}
                    unnormalArray.push({{ work_command.id }});
                {% endif %}
            {% endfor %}
            function checkVal() {
                $("#retrieve-button").show();
                $("input[name='work_command_id']:checked").each(
                        function () {
                            if (jQuery.inArray(Number($(this).val()), unnormalArray) > -1) {
                                $("#retrieve-button").hide();
                                return;
                            }
                        }
                );
            }

            checkVal();
            $("input[type=checkbox]").click(function () {
                if ($("input[name='work_command_id']:checked").val() == undefined) {
                    $("button").hide();
                } else {
                    $("button").show();
                    checkVal();
                }
            });
            $("button").hide();
            {% if not permissions.work_command.schedule_work_command.can() %}
                $("input").attr("disabled", "disabled");
            {% endif %}
            $(document).tooltip();
        });
    </script>
{% endblock %}
{% block body %}
    <div class="ym-wrapper">
        <div class="ym-wbox">
            <div class="ym-fbox-text center" id="ym-message-dialog"
                 role="alert" aria-live="assertive">
                <p></p>
            </div>
            <form class="filter" action="{{ url_for('manufacture.work_command_list') }}">
                <label for="status">状态</label>
                <select name="status" id="status" required="required" size="1">
                    {% for status in status_list %}
                        <option value="{{ status[0] }}" title="{{ status[2] }}">{{ status[1] }}</option>
                    {% endfor %}
                </select>
                <label for="harbor">卸货点</label>
                <select name="harbor" id="harbor">
                    <option value="全部">全部</option>
                    {% for harbor in harbor_list %}
                        <option value="{{ harbor.name }}">{{ harbor.name }}</option>
                    {% endfor %}
                </select>
            </form>
            <form method="POST" id="work_command_form">
                <table class="bordertable">
                    <thead>
                    <tr>
                        <th><input type="checkbox" name="check_all"></th>
                        <th>工单号</th>
                        <th>子订单号</th>
                        <th>订单编号</th>
                        <th>产品名称</th>
                        <th>重量(KG)</th>
                        <th>数量</th>
                        <th>客户名称</th>
                        <th>卸货点</th>
                        <th>是否加急</th>
                        <th>工序</th>
                        <th>上道工序</th>
                        <th>状态</th>
                        <th>车间</th>
                        <th>班组</th>
                        <th>处理类型</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for work_command in work_command_list %}
                        <tr {% if work_command.status == 8 %}
                            class="box warning"{% endif %} >
                            <td>
                                <input type="checkbox" value="{{ work_command.id }}"
                                       name="work_command_id"/>
                            </td>
                            <td>{{ work_command.id }}</td>
                            <td>{{ work_command.sub_order_id }}</td>
                            <td>{{ work_command.sub_order.order.customer_order_number }}</td>
                            <td>{{ work_command.sub_order.product.name }}</td>
                            <td>{{ work_command.org_weight }}</td>
                            <td>{{ work_command.org_cnt }}({{ work_command.unit }})
                            </td>
                            <td>{{ work_command.order.customer.name }}</td>
                            <td>{{ work_command.harbor.name }}</td>
                            <td class="td-urgent">
                                {% if work_command.urgent %}是{% else %}
                                    否{% endif %}</td>
                            <td>{{ work_command.procedure.name }}</td>
                            <td>{{ work_command.previous_procedure.name }}</td>
                            <td title="{{ work_command.status_describe }}">{{ work_command.status_name }}</td>
                            <td>{% if work_command.department %}
                                {{ work_command.department.name }}
                            {% endif %}</td>
                            <td>
                                {% if work_command.team %}
                                    {{ work_command.team.name }}
                                {% endif %}
                            </td>
                            <td>{{ work_command.handle_type_name }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>

                {% from "pagination.html" import render_pagination %}
                {{ render_pagination(pagination) }}
                <input type="hidden" name="purl">
                {% if schedule %}
                    <button class="ym-button ym-add" id="schedule-button" type="button">
                        排产
                    </button>
                {% endif %}
                {% if retrieve %}
                    <button class="ym-button ym-delete" id="retrieve-button" type="button">
                        回收
                    </button>
                {% endif %}
            </form>
        </div>
    </div>
{% endblock %}
