{% extends "layout.html" %}

{% block custom_external %}
    <script src="{{ url_for("static", filename="js/new-receipt-dialog.js") }}"></script>
    <script type="text/javascript">
        $(function () {
            $('#unload_session_id').val($('input[type="radio"]:checked').val());
            $('input[type="radio"]').click(function () {
                // insert the selected session id into new receipt dialog
                $('#unload_session_id').val($(this).val());
            });
            $('#view-receipts-dialog').dialog({
                autoOpen:false
            });
            $('#view-receipts').click(function () {
                // pop a list of generated goods receipts
                var session_id = $("#unload_session_id").val();
                if (jQuery.type(session_id) == "undefined") {
                    alert("当前无记录");
                    return;
                }
                var dialog = $("#view-receipts-dialog");
                $("#view-receipts-dialog").children('ul').children('li').remove();
                $.getJSON("/cargo/ajax/receipts-list?unload_session_id=" + session_id,
                        function (data) {
                            dialog.children("ul").empty();
                            $.each(data, function (idx, v) {
                                dialog.children("ul").append(
                                        '<li><a href="/cargo/goods-receipt?id=' + v.id + '&purl=' + encodeURIComponent(location.href) + '">' +
                                                v.receipt_id + '(' + v.customer + ')' + '</a> </li>');
                            });
                            $('#view-receipts-dialog').dialog("open");
                        }).error(function (data) {
                            alert(data.responseText);
                        });
            });
        });
    </script>
{% endblock %}

{% block body %}
    <div class="ym-wrapper">
        <div class="ym-wbox">
            <div class="ym-fbox-button">
                <a href="{{ url_for('cargo.session_add') }}"
                   class="ym-button ym-add">{{ _("创建会话") }}</a>
                <button class="ym-button ym-edit"
                        id="new-receipt">{{ _("创建收货单") }}</button>
                <button class="ym-button ym-next"
                        id="view-receipts">{{ _("查看收货单") }}</button>
            </div>
            <table class="bordertable">
                <thead>
                <tr>
                    <th>&nbsp;</th>
                    <th>{{ _("编号") }}</th>
                    <th>{{ _("车牌号") }}</th>
                    <th>{{ _("创建时间") }}</th>
                    <th>{{ _("结束时间") }}</th>
                    <th>{{ _("状态") }}</th>
                </tr>
                </thead>
                <tbody>
                {% for session in sessions %}
                    <tr>
                        <td><input type="radio" value="{{ session.id }}"
                                   name="session_group"
                                {% if loop.first %} checked=true {% endif %}/>
                        </td>
                        <td>
                            <a href="{{ url_for("cargo.session_detail", id=session.id, backref=request.url) }}">{{ session.id }}</a>
                        </td>
                        <td>{{ session.plate }}</td>
                        <td>{{ session.create_time }}</td>
                        <td>{{ session.finish_time|default("----", true) }}</td>
                        <td>{{ session.status }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
            {% from "pagination.html" import render_pagination %}
            {{ render_pagination(pagination) }}
        </div>
    </div>
    {% include "cargo/goods-receipt-add.html" %}

    <div id="view-receipts-dialog" title="{{ _("查看收货单") }}">
        <ul></ul>
    </div>

{% endblock %}
