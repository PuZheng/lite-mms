<style>
    #urgent-input {
        margin-left: 0.5em;
    }
</style>
<script type="text/javascript">
    function init_dialog() {
    {% if sub_order.work_command_list or sub_order.order.refined %}
        $("input").attr("disabled", "disabled");
        $("select").attr("disabled", "disabled");
    {% endif %}
    {% if sub_order.urgent %}
        $("#urgent-input").attr("checked", "checked");
    {% endif %}
    {% if sub_order.returned %}
        $("#returned-input").attr("checked", "checked");
    {% endif %}
        var products = {{ products|safe }};
        var selected_product_type = $("#product_type").val();
        $.each(products[selected_product_type], function (idx, entry) {
            $("#product").append('<option value="' + entry.id + '">' + entry.name + '</option>');
        });
        var product_id = {{ sub_order.product.id }};
        $("#product").val(product_id);
        $("#product_type").change(function (ui) {
            var selected_product_type = $("#product_type").val();
            $("#product").empty();
            $.each(products[selected_product_type], function (idx, entry) {
                $('#product').append('<option value="' + entry.id + '">' + entry.name + '</option>');
                $("#product").val(product_id);
            });
        });
    }
    function calc_unit_weight() {
        var weight = $("input[name='weight']").val();
        var quantity = $("input[name='quantity']").val();
        if (weight.length && quantity != undefined && quantity.length) {
            return weight / quantity;
        } else {
            return null;
        }
    }

    function update_unit_weight() {
        var unit_weight = calc_unit_weight();
        var message = "({{ _("单位重量: ") }}";
        if (unit_weight != null) {
            message += unit_weight + " 公斤)";
            $("#unit_weight").text(message);
            $("#unit_weight").show();
        } else {
            $("#unit_weight").hide();
        }
    }

    $(function () {
        init_dialog();
        $("button[type=button]").click(function () {
            $("#view-sub-order-dialog").dialog("close");
        });

        $("input[name='weight']").focusout(update_unit_weight);
        $("input[name='quantity']").focusout(update_unit_weight);
        update_unit_weight();
        $("input[name='due_time']").attr("min", new Date().toJSON().substr(0, 10));
        $("select[name='harbor']").val('{{ sub_order.harbor.name }}');
        $("form").submit(function(){
            if($("#product").text().trim() == "{{ DEFAULT_PRODUCT_NAME }}" || $("#product-type").text().trim() == "{{ DEFAULT_PRODUCT_NAME }}" ){
                alert("产品及产品类型不能选择为默认加工件");
                return false;
            }
            if ($("#due_time").val() == "" ){
                alert("交易时间不能为空");
                return false;
            }
        });
        {% if sub_order.measured_by_weight %}
            $("select[name='harbor']").change(function () {
                if ($(this).val() != '{{ sub_order.unload_task.harbor.name }}') {
                    alert("该子订单的默认卸货点是'{{ sub_order.unload_task.harbor.name }}'");
                }
            });
        {% endif %}
    })
</script>
<form class="ym-form  ym-columnar linearize-form"
      action="{{ url_for('order.sub_order') }}"
      method="POST">

    <div class="ym-fbox-text">
        <label>子订单号</label> <input name="id" size="10" type="text"
                                   readonly="readonly"
                                   value="{{ sub_order.id }}"/>
    </div>
    <div class="ym-fbox-select">
        <label>产品类型</label>
        <select id="product_type" name="product_type" required="required">
            {% for t in product_types %}
                <option value="{{ t.id }}" {% if t.id == sub_order.product.product_type_id %}selected="selected"{% endif %}>
                    {{ t.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="ym-fbox-select">
        <label>产品名称</label>
        <select name="product" id="product" required="required">
        </select>
    </div>
    <div class="ym-fbox-text">
        <label>技术要求</label> <input name="tech_req" size="10"
                                   type="text"
                                   value="{{ sub_order.tech_req }}"/>
    </div>
    <div class="ym-fbox-text">
        <label>交货日期</label> <input name="due_time" size="10" id="due_time"
                                   type="date" required="required"
                                   value="{% if sub_order.due_time %}{{ sub_order.due_time.date() }}{% else %}{% endif %}"/>
    </div>
    <div class="ym-fbox-text">
        <label>净重(KG)</label> <input name="weight" size="10"
                                     type="text" required="required"
                                     value="{{ sub_order.weight }}"/>
    </div>
    {% if not sub_order.measured_by_weight %}
        <div class="ym-fbox-text">
            <label>规格</label>
            <input type="text" size="64" name="spec" id="spec"
                   value="{{ sub_order.spec }}">
        </div>
        <div class="ym-fbox-text">
            <label>型号</label>
            <input type="text" size="64" name="type" id="type"
                   value="{{ sub_order.type }}">
        </div>
        <div class="ym-fbox-text">
            <label>数量</label> <input name="quantity" size="10"
                                     type="number" min="1"
                                     required="required"
                                     value="{{ sub_order.quantity }}"/>
        </div>
        <div class="ym-fbox-text">
            <small><em><span id="unit_weight" class="highlight"></span></em>
            </small>
            <label>数量单位</label>
            <input name="unit" size="10"
                   type="text" required="required"
                   value="{{ sub_order.unit }}"/>
        </div>
    {% endif %}
    <div class="ym-fbox-text">
        <label>卸货点</label>
        <select name="harbor" required="required">
            {% for harbor in harbor_list %}
                <option value="{{ harbor.name }}">{{ harbor.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="ym-fbox-check">
        <input name="urgent" id="urgent-input"
               type="checkbox"/><label
            for="urgent-input">加急</label>
        <input name="returned" id="returned-input"
               type="checkbox"/><label
            for="returned-input">退货</label>
    </div>
    {% if purl %}
        <input type="hidden" name="purl" value="{{ purl }}">
    {% endif %}
    {% if not sub_order.work_command_list and not sub_order.order.refined %}
        <button class="ym-button ym-save">保存</button>
    {% endif %}
    <button class="ym-button ym-delete" type="button">取消</button>
</form>
